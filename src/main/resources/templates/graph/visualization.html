<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>Knowledge Graph - Zappa</title>
</head>
<body>
    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <div th:replace="~{fragments/layout :: alerts}"></div>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-project-diagram me-2"></i>Knowledge Graph
                    </h2>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" onclick="resetGraph()">
                            <i class="fas fa-refresh me-1"></i>Reset View
                        </button>
                        <button class="btn btn-outline-success" onclick="highlightHubs()">
                            <i class="fas fa-star me-1"></i>Highlight Hubs
                        </button>
                        <button class="btn btn-outline-info" onclick="toggleLabels()">
                            <i class="fas fa-eye me-1"></i>Toggle Labels
                        </button>
                        <button id="savePositionsBtn" class="btn btn-outline-warning" onclick="savePositions()" disabled>
                            <i class="fas fa-save me-1"></i>Positions Saved
                        </button>
                        <button class="btn btn-outline-danger" onclick="resetPositions()">
                            <i class="fas fa-undo me-1"></i>Reset Layout
                        </button>
                    </div>
                </div>

                <!-- Group Selection -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center">
                                            <label class="form-label me-3 mb-0">
                                                <i class="fas fa-filter me-1"></i>Graph Scope:
                                            </label>
                                            <select class="form-select form-select-sm me-3" id="groupSelector" onchange="changeGraphGroup()">
                                                <option value="">All Notes (Global Graph)</option>
                                                <option th:each="group : ${allGroups}"
                                                        th:value="${group.id}"
                                                        th:text="${group.name}"
                                                        th:style="'color: ' + ${group.displayColor}"
                                                        th:selected="${selectedGroup != null and selectedGroup.id == group.id}">Group</option>
                                            </select>
                                            <div class="form-check" th:if="${selectedGroup != null}">
                                                <input class="form-check-input" type="checkbox" id="includeSubGroups"
                                                       th:checked="${includeSubGroups}" onchange="changeGraphGroup()">
                                                <label class="form-check-label" for="includeSubGroups">
                                                    Include subgroups
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div th:if="${selectedGroup != null}" class="alert alert-info py-1 mb-0">
                                            <small>
                                                <i th:class="${selectedGroup.displayIcon} + ' me-1'"></i>
                                                <strong th:text="${selectedGroup.name}">Group</strong>
                                                <span th:text="'Graph (' + ${totalNodes} + ' nodes, ' + ${totalLinks} + ' links)'">Graph</span>
                                            </small>
                                        </div>
                                        <div th:if="${selectedGroup == null}" class="alert alert-secondary py-1 mb-0">
                                            <small>
                                                <i class="fas fa-globe me-1"></i>
                                                <strong>Global Graph</strong>
                                                <span th:text="'(' + ${totalNodes} + ' nodes, ' + ${totalLinks} + ' links)'">Graph</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tag Filtering -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <label class="form-label me-3 mb-0">
                                                <i class="fas fa-tags me-1"></i>Filter by Tags:
                                            </label>
                                            <input type="text" class="form-control form-control-sm me-3"
                                                   id="tagInput" placeholder="Enter tags (comma-separated)"
                                                   th:value="${selectedTags}">
                                            <select class="form-select form-select-sm me-3" id="tagFilterType" style="max-width: 120px;">
                                                <option value="any" th:selected="${tagFilter == 'any'}">Any Tags</option>
                                                <option value="all" th:selected="${tagFilter == 'all'}">All Tags</option>
                                            </select>
                                            <button class="btn btn-sm btn-outline-primary" onclick="applyTagFilter()">
                                                <i class="fas fa-filter me-1"></i>Apply
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex flex-wrap gap-1">
                                            <small class="text-muted me-2">Quick tags:</small>
                                            <span th:each="tag : ${allTags}"
                                                  th:if="${tagStat.count <= 8}"
                                                  class="badge bg-secondary quick-tag"
                                                  style="cursor: pointer;"
                                                  th:data-tag-name="${tag.name}">
                                                <span th:text="${tag.name}">Tag</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graph stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body py-2">
                                <h5 class="text-primary" th:text="${totalNodes}">0</h5>
                                <small class="text-muted">Nodes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body py-2">
                                <h5 class="text-success" th:text="${totalLinks}">0</h5>
                                <small class="text-muted">Links</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body py-2">
                                <h5 class="text-info" id="selectedNode">0</h5>
                                <small class="text-muted">Selected</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body py-2">
                                <h5 class="text-warning" id="connectedNodes">0</h5>
                                <small class="text-muted">Connected</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Graph visualization -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-network-wired me-2"></i>Interactive Graph
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="graph-container" style="height: 600px; background: #f8f9fa;">
                            <!-- Cytoscape.js will create its canvas here -->
                        </div>
                    </div>
                </div>

                <!-- Graph controls -->
                <div class="card mt-3">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label small">Link Type:</label>
                                <select id="linkTypeFilter" class="form-select form-select-sm" onchange="filterByLinkType()">
                                    <option value="">All Types</option>
                                    <option value="REFERENCES">References</option>
                                    <option value="EXTENDS">Extends</option>
                                    <option value="IMPLEMENTS">Implements</option>
                                    <option value="RELATES_TO">Related To</option>
                                    <option value="CONTRADICTS">Contradicts</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Min Weight:</label>
                                <input type="range" id="weightFilter" class="form-range" min="1" max="10" value="1"
                                       oninput="filterByWeight(this.value)">
                                <small class="text-muted">Weight: <span id="weightValue">1</span></small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="exportGraph()">
                                    <i class="fas fa-download me-1"></i>Export SVG
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Node details sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Node Details
                        </h6>
                    </div>
                    <div class="card-body" id="nodeDetails">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                            <p>Click on a node to see details</p>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-palette me-2"></i>Legend
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="mb-2">
                                <strong>Graph Legend:</strong>
                            </div>

                            <div class="mb-2">
                                <strong>Link Colors (Weight):</strong>
                            </div>
                            <div class="mb-1">
                                <span style="display: inline-block; width: 20px; height: 3px; background-color: #dc3545; margin-right: 5px;"></span>
                                <small>Critical (8-10)</small>
                            </div>
                            <div class="mb-1">
                                <span style="display: inline-block; width: 20px; height: 3px; background-color: #fd7e14; margin-right: 5px;"></span>
                                <small>Important (6-7)</small>
                            </div>
                            <div class="mb-1">
                                <span style="display: inline-block; width: 20px; height: 3px; background-color: #ffc107; margin-right: 5px;"></span>
                                <small>Moderate (4-5)</small>
                            </div>
                            <div class="mb-3">
                                <span style="display: inline-block; width: 20px; height: 3px; background-color: #28a745; margin-right: 5px;"></span>
                                <small>Light (1-3)</small>
                            </div>

                            <div class="mb-2">
                                <strong>Node Size:</strong> Connection count
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick actions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="findShortestPath()">
                                <i class="fas fa-route me-1"></i>Find Path
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="centerGraph()">
                                <i class="fas fa-crosshairs me-1"></i>Center Graph
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showStats()">
                                <i class="fas fa-chart-bar me-1"></i>Show Stats
                            </button>
                            <a href="/notes/new" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-plus me-1"></i>Add Note
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <!-- Path finding modal -->
    <div class="modal fade" id="pathModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Find Shortest Path</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Select two nodes on the graph, then click this button to find the shortest path between them.</p>
                    <div id="pathResult"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: scripts}"></div>

    <!-- D3.js -->
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

    <script>
        // Graph visualization with Cytoscape.js
        let cy = null;
        let graphData = null;
        let selectedNodes = [];
        let showLabels = true;
        let positionsModified = false;

        // Weight-based color function
        function getLinkColor(weight) {
            if (weight >= 8) return '#dc3545';      // Red - Critical
            if (weight >= 6) return '#fd7e14';      // Orange - Important
            if (weight >= 4) return '#ffc107';      // Yellow - Moderate
            return '#28a745';                       // Green - Light
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeGraph();
            loadGraphData();

            // Add event listeners for quick tag buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.quick-tag')) {
                    const tagName = e.target.closest('.quick-tag').getAttribute('data-tag-name');
                    if (tagName) {
                        addQuickTag(tagName);
                    }
                }
            });
        });

        function initializeGraph() {
            const container = document.getElementById('graph-container');

            cy = cytoscape({
                container: container,
                style: [
                    // Node styles
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'data(color)',
                            'width': 'data(size)',
                            'height': 'data(size)',
                            'label': 'data(title)',
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'color': '#333',
                            'text-background-color': 'white',
                            'text-background-opacity': 0.8,
                            'text-background-padding': '2px',
                            'border-width': 2,
                            'border-color': '#fff'
                        }
                    },
                    // Edge styles
                    {
                        selector: 'edge',
                        style: {
                            'line-color': 'data(color)',
                            'width': 'data(width)',
                            'opacity': 0.8,
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': 'data(color)'
                        }
                    },
                    // Selected node styles
                    {
                        selector: 'node:selected',
                        style: {
                            'border-color': '#dc3545',
                            'border-width': 4
                        }
                    },
                    // Highlighted styles
                    {
                        selector: '.highlighted',
                        style: {
                            'opacity': 1
                        }
                    },
                    {
                        selector: '.dimmed',
                        style: {
                            'opacity': 0.3
                        }
                    },
                    // Path highlight styles
                    {
                        selector: '.path-highlight',
                        style: {
                            'line-color': '#ff6b6b',
                            'target-arrow-color': '#ff6b6b',
                            'width': 6,
                            'opacity': 1
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    nodeOverlap: 20,
                    idealEdgeLength: 100,
                    edgeElasticity: 100,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 1000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0
                }
            });

            // Add event listeners
            setupCytoscapeEvents();
        }

        function setupCytoscapeEvents() {
            // Node click event
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const nodeId = node.id();

                // Toggle selection
                if (selectedNodes.includes(nodeId)) {
                    selectedNodes = selectedNodes.filter(id => id !== nodeId);
                    node.unselect();
                } else {
                    selectedNodes.push(nodeId);
                    if (selectedNodes.length > 2) {
                        const oldNode = cy.getElementById(selectedNodes.shift());
                        oldNode.unselect();
                    }
                    node.select();
                }

                loadNodeDetails(nodeId);
                updateSelectedCount();
            });

            // Node hover effects
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                const connectedEdges = node.connectedEdges();
                const connectedNodes = connectedEdges.connectedNodes();

                // Dim all elements
                cy.elements().addClass('dimmed');

                // Highlight connected elements
                node.removeClass('dimmed').addClass('highlighted');
                connectedNodes.removeClass('dimmed').addClass('highlighted');
                connectedEdges.removeClass('dimmed').addClass('highlighted');

                document.getElementById('connectedNodes').textContent = connectedNodes.length;
            });

            cy.on('mouseout', 'node', function(evt) {
                cy.elements().removeClass('dimmed highlighted');
                document.getElementById('connectedNodes').textContent = '0';
            });

            // Edge hover effects
            cy.on('mouseover', 'edge', function(evt) {
                const edge = evt.target;
                edge.style('width', Math.max(6, edge.data('width') * 1.5));
            });

            cy.on('mouseout', 'edge', function(evt) {
                const edge = evt.target;
                edge.style('width', edge.data('width'));
            });

            // Track position changes
            cy.on('position', 'node', function(evt) {
                positionsModified = true;
                updateSaveButtonState();
            });

            cy.on('free', 'node', function(evt) {
                // Auto-save positions after drag ends
                if (positionsModified) {
                    savePositions();
                }
            });
        }

        function loadGraphData() {
            const groupId = getSelectedGroupId();
            const includeSubGroups = getIncludeSubGroups();
            const tags = getSelectedTags();
            const tagFilter = getTagFilterType();

            let url = '/graph/data';
            const params = new URLSearchParams();

            if (groupId) {
                params.append('group', groupId);
                params.append('includeSubGroups', includeSubGroups);
            }

            if (tags) {
                params.append('tags', tags);
                params.append('tagFilter', tagFilter);
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    graphData = data;
                    renderGraph();
                })
                .catch(error => {
                    console.error('Error loading graph data:', error);
                    showError('Failed to load graph data');
                });
        }

        function getSelectedGroupId() {
            const selector = document.getElementById('groupSelector');
            return selector ? selector.value : '';
        }

        function getIncludeSubGroups() {
            const checkbox = document.getElementById('includeSubGroups');
            return checkbox ? checkbox.checked : false;
        }

        function getSelectedTags() {
            const input = document.getElementById('tagInput');
            return input ? input.value.trim() : '';
        }

        function getTagFilterType() {
            const select = document.getElementById('tagFilterType');
            return select ? select.value : 'any';
        }

        function applyTagFilter() {
            const groupId = getSelectedGroupId();
            const includeSubGroups = getIncludeSubGroups();
            const tags = getSelectedTags();
            const tagFilter = getTagFilterType();

            // Update URL to reflect current selection
            const url = new URL(window.location);

            if (groupId) {
                url.searchParams.set('group', groupId);
                url.searchParams.set('includeSubGroups', includeSubGroups);
            } else {
                url.searchParams.delete('group');
                url.searchParams.delete('includeSubGroups');
            }

            if (tags) {
                url.searchParams.set('tags', tags);
                url.searchParams.set('tagFilter', tagFilter);
            } else {
                url.searchParams.delete('tags');
                url.searchParams.delete('tagFilter');
            }

            // Update URL without page reload
            window.history.pushState({}, '', url);

            // Reload graph data
            loadGraphData();
        }

        function addQuickTag(tagName) {
            const tagInput = document.getElementById('tagInput');
            const currentTags = tagInput.value.trim();

            if (currentTags) {
                const tagList = currentTags.split(',').map(t => t.trim());
                if (!tagList.includes(tagName)) {
                    tagInput.value = currentTags + ', ' + tagName;
                }
            } else {
                tagInput.value = tagName;
            }

            applyTagFilter();
        }

        function changeGraphGroup() {
            const groupId = getSelectedGroupId();
            const includeSubGroups = getIncludeSubGroups();

            // Update URL to reflect current selection
            const url = new URL(window.location);
            if (groupId) {
                url.searchParams.set('group', groupId);
                url.searchParams.set('includeSubGroups', includeSubGroups);
            } else {
                url.searchParams.delete('group');
                url.searchParams.delete('includeSubGroups');
            }

            // Update URL without page reload
            window.history.pushState({}, '', url);

            // Reload graph data
            loadGraphData();
        }

        function renderGraph() {
            if (!graphData || !cy) return;

            // Convert D3 format to Cytoscape format
            const elements = [];

            // Add nodes
            graphData.nodes.forEach(node => {
                elements.push({
                    data: {
                        id: node.id,
                        title: node.title,
                        color: node.color,
                        size: node.size * 2, // Cytoscape sizes work differently
                        linkCount: node.linkCount
                    }
                });
            });

            // Add edges
            graphData.links.forEach(link => {
                elements.push({
                    data: {
                        id: `${link.source.id || link.source}-${link.target.id || link.target}`,
                        source: link.source.id || link.source,
                        target: link.target.id || link.target,
                        color: getLinkColor(link.weight),
                        width: Math.max(2, link.weight / 2),
                        weight: link.weight,
                        type: link.type
                    }
                });
            });

            // Update graph with new data
            cy.elements().remove();
            cy.add(elements);

            // Run layout
            const layout = cy.layout({
                name: 'cose',
                animate: true,
                animationDuration: 1000,
                fit: true,
                padding: 50,
                idealEdgeLength: 100,
                nodeOverlap: 20
            });

            layout.run();

            // Reset selections
            selectedNodes = [];
            updateSelectedCount();

            // Load saved positions after layout
            layout.on('layoutstop', function() {
                loadSavedPositions();
            });
        }

        // Hybrid storage: localStorage + server API
        let serverSaveTimeout = null;

        function savePositions() {
            if (!cy) return;

            const positions = {};
            cy.nodes().forEach(node => {
                const pos = node.position();
                positions[node.id()] = { x: pos.x, y: pos.y };
            });

            const groupKey = getSelectedGroupId() || 'global';

            // 1. Immediate save to localStorage (fast)
            const storageKey = `graph-positions-${groupKey}`;
            const positionData = {
                positions: positions,
                timestamp: Date.now(),
                groupKey: groupKey
            };
            localStorage.setItem(storageKey, JSON.stringify(positionData));

            // 2. Debounced save to server (background)
            clearTimeout(serverSaveTimeout);
            serverSaveTimeout = setTimeout(() => {
                saveToServer(groupKey, positions);
            }, 2000); // Wait 2 seconds before saving to server

            positionsModified = false;
            updateSaveButtonState();

            // Show temporary success message
            showToast('Positions saved locally!', 'success');
        }

        async function saveToServer(groupKey, positions) {
            try {
                const response = await fetch(`/api/graph/positions/${groupKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(positions)
                });

                if (response.ok) {
                    showToast('Positions synced to server!', 'info');
                } else {
                    console.warn('Failed to save positions to server:', response.status);
                }
            } catch (error) {
                console.warn('Server save failed (offline?):', error);
            }
        }

        async function loadSavedPositions() {
            if (!cy) return;

            const groupKey = getSelectedGroupId() || 'global';
            const storageKey = `graph-positions-${groupKey}`;

            // 1. Try localStorage first (instant)
            const localData = localStorage.getItem(storageKey);
            let localPositions = null;
            let localTimestamp = 0;

            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    localPositions = parsed.positions || parsed; // Support old format
                    localTimestamp = parsed.timestamp || 0;

                    // Apply local positions immediately
                    applyPositions(localPositions);
                    console.log('Applied local positions');
                } catch (e) {
                    console.warn('Failed to load local positions:', e);
                }
            }

            // 2. Load from server and merge (background)
            try {
                const response = await fetch(`/api/graph/positions/${groupKey}`);
                if (response.ok) {
                    const serverPositions = await response.json();

                    // Use server positions if local is missing or server is newer
                    if (!localPositions || Object.keys(serverPositions).length > 0) {
                        applyPositions(serverPositions);

                        // Update localStorage with server data
                        const positionData = {
                            positions: serverPositions,
                            timestamp: Date.now(),
                            groupKey: groupKey
                        };
                        localStorage.setItem(storageKey, JSON.stringify(positionData));

                        console.log('Applied server positions and synced to localStorage');
                    }
                }
            } catch (error) {
                console.log('Server load failed (using local positions):', error);
            }
        }

        function applyPositions(positions) {
            if (!positions || !cy) return;

            cy.nodes().forEach(node => {
                const nodeId = node.id();
                if (positions[nodeId]) {
                    node.position(positions[nodeId]);
                }
            });
        }

        async function resetPositions() {
            const groupKey = getSelectedGroupId() || 'global';
            const storageKey = `graph-positions-${groupKey}`;

            // Clear localStorage
            localStorage.removeItem(storageKey);

            // Clear server storage
            try {
                await fetch(`/api/graph/positions/${groupKey}`, {
                    method: 'DELETE'
                });
                console.log('Cleared server positions');
            } catch (error) {
                console.warn('Failed to clear server positions:', error);
            }

            positionsModified = false;
            updateSaveButtonState();

            // Re-run layout
            const layout = cy.layout({
                name: 'cose',
                animate: true,
                animationDuration: 1000,
                fit: true,
                padding: 50
            });
            layout.run();

            showToast('Positions reset to automatic layout', 'info');
        }

        function updateSaveButtonState() {
            const saveBtn = document.getElementById('savePositionsBtn');
            if (saveBtn) {
                saveBtn.disabled = !positionsModified;
                saveBtn.textContent = positionsModified ? 'Save Positions' : 'Positions Saved';
            }
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
            toast.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        function updateSelectedCount() {
            document.getElementById('selectedNode').textContent = selectedNodes.length;
        }

        function loadNodeDetails(nodeId) {
            fetch(`/graph/node/${nodeId}`)
                .then(response => response.json())
                .then(data => {
                    const detailsContainer = document.getElementById('nodeDetails');
                    detailsContainer.innerHTML = `
                        <h6>${data.title}</h6>
                        <p class="small text-muted">${data.content || 'No content'}</p>
                        <div class="mb-2">
                        </div>
                        <div class="mb-2">
                            ${data.tags.map(tag => `<span class="badge bg-primary">${tag}</span>`).join(' ')}
                        </div>
                        <hr>
                        <div class="small">
                            <div><strong>Total Links:</strong> ${data.totalLinks}</div>
                            <div><strong>Avg Weight:</strong> ${data.averageWeight?.toFixed(1) || 'N/A'}</div>
                        </div>
                        <hr>
                        <div class="small">
                            <div><strong>Outgoing (${data.outgoingLinks.length}):</strong></div>
                            ${data.outgoingLinks.map(link =>
                                `<div class="ms-2">→ ${link.target} (${link.type})</div>`
                            ).join('')}
                            <div class="mt-2"><strong>Incoming (${data.incomingLinks.length}):</strong></div>
                            ${data.incomingLinks.map(link =>
                                `<div class="ms-2">← ${link.source} (${link.type})</div>`
                            ).join('')}
                        </div>
                        <hr>
                        <div class="d-grid gap-1">
                            <a href="/notes/${data.id}" class="btn btn-sm btn-primary">View Note</a>
                            <a href="/notes/${data.id}/edit" class="btn btn-sm btn-outline-secondary">Edit Note</a>
                        </div>
                    `;
                })
                .catch(error => console.error('Error loading node details:', error));
        }

        function updateSelectedCount() {
            document.getElementById('selectedNode').textContent = selectedNodes.length;
        }

        function resetGraph() {
            if (!cy) return;
            selectedNodes = [];
            cy.elements().unselect();
            cy.elements().removeClass('dimmed highlighted');
            updateSelectedCount();
            cy.fit();
        }

        function highlightHubs() {
            if (!cy || !graphData) return;
            const maxConnections = Math.max(...graphData.nodes.map(n => n.linkCount));
            const threshold = maxConnections * 0.7;

            cy.nodes().forEach(node => {
                const linkCount = node.data('linkCount');
                if (linkCount >= threshold) {
                    node.style({
                        'border-color': '#ffc107',
                        'border-width': 6
                    });
                } else {
                    node.style({
                        'border-color': '#fff',
                        'border-width': 2
                    });
                }
            });
        }

        function toggleLabels() {
            if (!cy) return;
            showLabels = !showLabels;
            if (showLabels) {
                cy.style().selector('node').style('label', 'data(title)').update();
            } else {
                cy.style().selector('node').style('label', '').update();
            }
        }


        function filterByLinkType() {
            if (!cy) return;
            const linkType = document.getElementById('linkTypeFilter').value;

            cy.edges().forEach(edge => {
                if (!linkType || edge.data('type') === linkType) {
                    edge.style('opacity', 0.8);
                } else {
                    edge.style('opacity', 0.1);
                }
            });
        }

        function filterByWeight(value) {
            if (!cy) return;
            document.getElementById('weightValue').textContent = value;

            cy.edges().forEach(edge => {
                if (edge.data('weight') >= value) {
                    edge.style('opacity', 0.8);
                } else {
                    edge.style('opacity', 0.1);
                }
            });
        }

        function findShortestPath() {
            if (selectedNodes.length !== 2) {
                alert('Please select exactly 2 nodes to find the shortest path');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('pathModal'));
            modal.show();

            // Find shortest path using Cytoscape's built-in algorithm
            const node1 = cy.getElementById(selectedNodes[0]);
            const node2 = cy.getElementById(selectedNodes[1]);
            const path = cy.elements().dijkstra(node1, function(edge) {
                return edge.data('weight');
            }).pathTo(node2);

            // Highlight the path
            cy.elements().removeClass('path-highlight');
            path.addClass('path-highlight');
        }

        function centerGraph() {
            if (!cy) return;
            cy.fit(null, 50);
        }

        function showStats() {
            fetch('/graph/stats')
                .then(response => response.json())
                .then(stats => {
                    alert(`Graph Statistics:\n\nNodes: ${stats.totalNodes}\nLinks: ${stats.totalLinks}\nOrphaned: ${stats.orphanedNodes}\n\nMost Connected:\n${stats.hubs.map(hub => `• ${hub.title} (${hub.linkCount} links)`).join('\n')}`);
                });
        }

        function exportGraph() {
            if (!cy) return;

            // Export as PNG using Cytoscape's built-in export
            const png64 = cy.png({
                output: 'blob',
                bg: 'white',
                full: true,
                scale: 2
            });

            const a = document.createElement('a');
            a.href = URL.createObjectURL(png64);
            a.download = 'knowledge-graph.png';
            a.click();
        }

        function showError(message) {
            const container = document.getElementById('graph-container');
            container.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center text-muted">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>Error Loading Graph</h5>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="loadGraphData()">
                            <i class="fas fa-refresh me-1"></i>Retry
                        </button>
                    </div>
                </div>
            `;
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (cy) {
                cy.resize();
                cy.fit();
            }
        });

        // Sync to server on page unload
        window.addEventListener('beforeunload', function() {
            if (positionsModified && cy) {
                const positions = {};
                cy.nodes().forEach(node => {
                    const pos = node.position();
                    positions[node.id()] = { x: pos.x, y: pos.y };
                });

                const groupKey = getSelectedGroupId() || 'global';

                // Synchronous save for page unload
                navigator.sendBeacon(`/api/graph/positions/${groupKey}`,
                    JSON.stringify(positions));
            }
        });
    </script>
</body>
</html>